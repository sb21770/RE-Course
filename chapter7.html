<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 7: PE Format</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #131a2b;
            --bg-card: #1a2235;
            --accent-primary: #00ff88;
            --accent-secondary: #00b4d8;
            --accent-warning: #ff6b35;
            --accent-purple: #a855f7;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --border-color: #2a3548;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.9; }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        nav { background: var(--bg-secondary); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
        nav a { color: var(--accent-primary); text-decoration: none; }
        .chapter-header { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); padding: 4rem 2rem; text-align: center; border-bottom: 1px solid var(--border-color); }
        .chapter-number { display: inline-block; background: linear-gradient(135deg, #00ff88 0%, #00b4d8 100%); color: var(--bg-primary); padding: 0.5rem 1.5rem; border-radius: 30px; font-weight: 700; margin-bottom: 1rem; }
        h1 { font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #00ff88 0%, #00b4d8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: var(--text-secondary); font-size: 1.1rem; }
        .content { padding: 3rem 0; }
        h2 { font-size: 1.8rem; color: var(--accent-primary); margin: 3rem 0 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color); }
        h3 { font-size: 1.3rem; color: var(--accent-secondary); margin: 2rem 0 1rem; }
        p { margin-bottom: 1.5rem; }
        .definition { background: var(--bg-card); border-left: 4px solid var(--accent-primary); padding: 1.5rem; border-radius: 0 10px 10px 0; margin: 1.5rem 0; }
        .definition-title { color: var(--accent-primary); font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .info-box { background: rgba(0, 180, 216, 0.1); border: 1px solid var(--accent-secondary); border-radius: 10px; padding: 1.5rem; margin: 1.5rem 0; }
        .info-box-title { color: var(--accent-secondary); font-weight: 700; margin-bottom: 0.5rem; }
        ul, ol { margin: 1rem 0 1.5rem 1.5rem; }
        li { margin-bottom: 0.8rem; }
        code { font-family: 'Fira Code', monospace; background: var(--bg-card); padding: 0.2rem 0.5rem; border-radius: 4px; color: var(--accent-primary); font-size: 0.9rem; }
        pre { font-family: 'Fira Code', monospace; background: var(--bg-card); padding: 1.5rem; border-radius: 10px; overflow-x: auto; margin: 1.5rem 0; border: 1px solid var(--border-color); line-height: 1.6; }
        .diagram { background: var(--bg-card); border-radius: 15px; padding: 2rem; margin: 2rem 0; text-align: center; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; background: var(--bg-card); border-radius: 10px; overflow: hidden; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-secondary); color: var(--accent-primary); font-weight: 600; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--border-color); }
        .nav-btn { background: var(--bg-card); color: var(--text-primary); padding: 1rem 2rem; border-radius: 10px; text-decoration: none; border: 1px solid var(--border-color); transition: all 0.3s; }
        .nav-btn:hover { border-color: var(--accent-primary); transform: translateY(-3px); }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">â† Back to Main Menu</a>
    </nav>

    <header class="chapter-header">
        <div class="chapter-number">Chapter 7</div>
        <h1>PE Format</h1>
        <p class="subtitle">Structure of EXE and DLL files in Windows</p>
    </header>

    <div class="container">
        <div class="content">
            
            <h2>ğŸ“¦ What is PE?</h2>

            <div class="definition">
                <div class="definition-title">ğŸ“– Definition: PE (Portable Executable)</div>
                <p>The executable file format for Windows. Includes <code>.exe</code>, <code>.dll</code>, <code>.sys</code>, <code>.ocx</code> and more.<br>
                "Portable" because the same format works on all Windows versions.</p>
            </div>

            <p>
                When you open an EXE file in a Hex Editor or RE tool, you see the PE structure.
                Understanding this format is essential for analyzing malware and suspicious files.
            </p>

            <h2>ğŸ”¨ Who Creates the PE Structure?</h2>

            <p>
                The developer only writes source code. The <strong>compiler</strong> and <strong>linker</strong> 
                automatically create all the PE headers, signatures, and structure!
            </p>

            <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FROM CODE TO EXE                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     DEVELOPER                    COMPILER                   LINKER
    writes this:                creates this:             creates this:
         â”‚                           â”‚                         â”‚
         â–¼                           â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   main.c        â”‚         â”‚   main.obj      â”‚       â”‚   program.exe   â”‚
â”‚                 â”‚         â”‚                 â”‚       â”‚                 â”‚
â”‚ #include &lt;...&gt;  â”‚         â”‚ Machine code    â”‚       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                 â”‚  â”€â”€â”€â–º   â”‚ (just the code, â”‚ â”€â”€â”€â–º  â”‚ â”‚ DOS Header  â”‚ â”‚
â”‚ int main() {    â”‚ compile â”‚  no headers)    â”‚ link  â”‚ â”‚ DOS Stub    â”‚ â”‚
â”‚   printf("Hi"); â”‚         â”‚                 â”‚       â”‚ â”‚ PE Sig      â”‚ â”‚
â”‚   return 0;     â”‚         â”‚ Symbols:        â”‚       â”‚ â”‚ File Header â”‚ â”‚
â”‚ }               â”‚         â”‚ - main          â”‚       â”‚ â”‚ Opt Header  â”‚ â”‚
â”‚                 â”‚         â”‚ - printf (ref)  â”‚       â”‚ â”‚ Sections    â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚ .text       â”‚ â”‚
                                                      â”‚ â”‚ .data       â”‚ â”‚
     YOU write                COMPILER does           â”‚ â”‚ Imports     â”‚ â”‚
     only this!               the translation         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      
                                                       LINKER builds
                                                       the complete
                                                       PE structure!
            </pre>

            <div class="info-box">
                <div class="info-box-title">ğŸ’¡ Summary: Who Does What?</div>
                <table style="margin: 0.5rem 0; font-size: 0.9rem;">
                    <tr>
                        <th>Role</th>
                        <th>Creates</th>
                    </tr>
                    <tr>
                        <td><strong>Developer</strong></td>
                        <td>Source code only (what the program does)</td>
                    </tr>
                    <tr>
                        <td><strong>Compiler</strong></td>
                        <td>Machine code (translated instructions)</td>
                    </tr>
                    <tr>
                        <td><strong>Linker</strong></td>
                        <td>Complete PE structure (DOS Header, PE Signature, all headers, sections, imports)</td>
                    </tr>
                </table>
            </div>

            <h2>ğŸ—‚ï¸ General PE Structure</h2>

            <div class="diagram">
                <svg viewBox="0 0 450 520" xmlns="http://www.w3.org/2000/svg">
                    <!-- Headers bracket -->
                    <text x="35" y="130" text-anchor="middle" fill="#a0a0a0" font-size="10" font-weight="bold" transform="rotate(-90, 35, 130)">HEADERS</text>
                    <line x1="50" y1="20" x2="50" y2="270" stroke="#a0a0a0" stroke-width="1"/>
                    <line x1="50" y1="20" x2="60" y2="20" stroke="#a0a0a0" stroke-width="1"/>
                    <line x1="50" y1="270" x2="60" y2="270" stroke="#a0a0a0" stroke-width="1"/>
                    
                    <!-- DOS Header -->
                    <rect x="70" y="15" width="200" height="45" rx="5" fill="#1a2235" stroke="#ff6b35" stroke-width="2"/>
                    <text x="170" y="42" text-anchor="middle" fill="#ff6b35" font-size="12" font-weight="bold">DOS Header</text>
                    <text x="285" y="42" fill="#a0a0a0" font-size="9" font-family="Fira Code">64 bytes</text>
                    
                    <!-- DOS Stub -->
                    <rect x="70" y="65" width="200" height="30" rx="5" fill="#1a2235" stroke="#a0a0a0" stroke-width="1" stroke-dasharray="4"/>
                    <text x="170" y="85" text-anchor="middle" fill="#a0a0a0" font-size="10">DOS Stub (optional)</text>
                    
                    <!-- PE Signature -->
                    <rect x="70" y="100" width="200" height="30" rx="5" fill="#1a2235" stroke="#00ff88" stroke-width="2"/>
                    <text x="170" y="120" text-anchor="middle" fill="#00ff88" font-size="11" font-weight="bold" font-family="Fira Code">"PE\0\0"</text>
                    <text x="285" y="120" fill="#a0a0a0" font-size="9" font-family="Fira Code">4 bytes</text>
                    
                    <!-- File Header -->
                    <rect x="70" y="135" width="200" height="40" rx="5" fill="#1a2235" stroke="#00b4d8" stroke-width="2"/>
                    <text x="170" y="160" text-anchor="middle" fill="#00b4d8" font-size="11" font-weight="bold">File Header (COFF)</text>
                    <text x="285" y="160" fill="#a0a0a0" font-size="9" font-family="Fira Code">20 bytes</text>
                    
                    <!-- Optional Header -->
                    <rect x="70" y="180" width="200" height="50" rx="5" fill="#1a2235" stroke="#a855f7" stroke-width="2"/>
                    <text x="170" y="202" text-anchor="middle" fill="#a855f7" font-size="11" font-weight="bold">Optional Header</text>
                    <text x="170" y="218" text-anchor="middle" fill="#a0a0a0" font-size="8">(despite name, it's required!)</text>
                    <text x="285" y="205" fill="#a0a0a0" font-size="9" font-family="Fira Code">~240 bytes</text>
                    
                    <!-- Section Headers box -->
                    <rect x="70" y="235" width="200" height="80" rx="5" fill="#0a0e17" stroke="#00ff88" stroke-width="2"/>
                    <text x="170" y="255" text-anchor="middle" fill="#00ff88" font-size="11" font-weight="bold">Section Headers</text>
                    <text x="170" y="270" text-anchor="middle" fill="#a0a0a0" font-size="8">(Table of Contents)</text>
                    
                    <!-- Individual section header entries -->
                    <rect x="80" y="278" width="85" height="16" rx="2" fill="#1a2235" stroke="#00b4d8" stroke-width="1"/>
                    <text x="122" y="290" text-anchor="middle" fill="#00b4d8" font-size="7" font-family="Fira Code">.text header</text>
                    
                    <rect x="170" y="278" width="85" height="16" rx="2" fill="#1a2235" stroke="#ff6b35" stroke-width="1"/>
                    <text x="212" y="290" text-anchor="middle" fill="#ff6b35" font-size="7" font-family="Fira Code">.data header</text>
                    
                    <rect x="80" y="296" width="85" height="16" rx="2" fill="#1a2235" stroke="#a855f7" stroke-width="1"/>
                    <text x="122" y="308" text-anchor="middle" fill="#a855f7" font-size="7" font-family="Fira Code">.rsrc header</text>
                    
                    <text x="285" y="290" fill="#a0a0a0" font-size="9" font-family="Fira Code">40 bytes Ã— n</text>
                    
                    <!-- Arrows from headers to sections -->
                    <defs>
                        <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#a0a0a0"/>
                        </marker>
                    </defs>
                    
                    <path d="M122 314 L122 340 L120 365" stroke="#00b4d8" stroke-width="1.5" fill="none" stroke-dasharray="3" marker-end="url(#arrowhead)"/>
                    <path d="M212 314 L212 350 L190 410" stroke="#ff6b35" stroke-width="1.5" fill="none" stroke-dasharray="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Sections bracket -->
                    <text x="35" y="420" text-anchor="middle" fill="#a0a0a0" font-size="10" font-weight="bold" transform="rotate(-90, 35, 420)">SECTIONS (actual data)</text>
                    <line x1="50" y1="330" x2="50" y2="510" stroke="#a0a0a0" stroke-width="1"/>
                    <line x1="50" y1="330" x2="60" y2="330" stroke="#a0a0a0" stroke-width="1"/>
                    <line x1="50" y1="510" x2="60" y2="510" stroke="#a0a0a0" stroke-width="1"/>
                    
                    <!-- Gap -->
                    <text x="170" y="345" text-anchor="middle" fill="#a0a0a0" font-size="9">â†“ points to â†“</text>
                    
                    <!-- Actual Sections -->
                    <rect x="70" y="360" width="200" height="45" rx="5" fill="#1a2235" stroke="#00b4d8" stroke-width="2"/>
                    <text x="170" y="380" text-anchor="middle" fill="#00b4d8" font-size="11" font-weight="bold" font-family="Fira Code">.text</text>
                    <text x="170" y="395" text-anchor="middle" fill="#a0a0a0" font-size="8">(executable code)</text>
                    
                    <rect x="70" y="410" width="200" height="45" rx="5" fill="#1a2235" stroke="#ff6b35" stroke-width="2"/>
                    <text x="170" y="430" text-anchor="middle" fill="#ff6b35" font-size="11" font-weight="bold" font-family="Fira Code">.data</text>
                    <text x="170" y="445" text-anchor="middle" fill="#a0a0a0" font-size="8">(initialized variables)</text>
                    
                    <rect x="70" y="460" width="200" height="45" rx="5" fill="#1a2235" stroke="#a855f7" stroke-width="2"/>
                    <text x="170" y="480" text-anchor="middle" fill="#a855f7" font-size="11" font-weight="bold" font-family="Fira Code">.rsrc, .rdata, ...</text>
                    <text x="170" y="495" text-anchor="middle" fill="#a0a0a0" font-size="8">(resources, read-only data)</text>
                    
                    <!-- Legend box -->
                    <rect x="310" y="360" width="130" height="90" rx="5" fill="#131a2b" stroke="#2a3548" stroke-width="1"/>
                    <text x="375" y="380" text-anchor="middle" fill="#00ff88" font-size="9" font-weight="bold">Legend</text>
                    <text x="320" y="400" fill="#a0a0a0" font-size="8">Section Header:</text>
                    <text x="320" y="415" fill="#a0a0a0" font-size="7">Metadata (40 bytes)</text>
                    <text x="320" y="432" fill="#a0a0a0" font-size="8">Section:</text>
                    <text x="320" y="447" fill="#a0a0a0" font-size="7">Actual content (code/data)</text>
                </svg>
            </div>
            
            <div class="info-box">
                <div class="info-box-title">ğŸ’¡ Section Headers vs Sections - What's the difference?</div>
                <table style="margin: 0.5rem 0; font-size: 0.9rem;">
                    <tr>
                        <th>Term</th>
                        <th>What is it</th>
                        <th>Analogy</th>
                    </tr>
                    <tr>
                        <td><strong>Section Headers</strong></td>
                        <td>Metadata describing each section (name, size, location, permissions)</td>
                        <td>Table of Contents in a book</td>
                    </tr>
                    <tr>
                        <td><strong>Sections</strong></td>
                        <td>The actual code/data content (.text, .data, .rsrc)</td>
                        <td>The actual chapters in a book</td>
                    </tr>
                </table>
                <p style="margin: 0.5rem 0 0 0;">
                    <strong>Each Section Header (40 bytes) tells you WHERE to find its Section in the file!</strong>
                </p>
            </div>

            <h2>ğŸ“‹ DOS Header</h2>

            <div class="definition">
                <div class="definition-title">ğŸ“– Definition: DOS Header</div>
                <p>The first 64 bytes of every PE. Starts with <code>MZ</code> (0x4D5A) - initials of Mark Zbikowski, a Microsoft programmer.</p>
            </div>

            <p>Important fields (these are actual field names from the Windows <code>IMAGE_DOS_HEADER</code> structure):</p>
            
            <table>
                <tr>
                    <th>Field</th>
                    <th>Location</th>
                    <th>Value</th>
                    <th>Meaning</th>
                </tr>
                <tr>
                    <td><code>e_magic</code></td>
                    <td>Offset 0x00 (fixed)</td>
                    <td><code>4D 5A</code> = "MZ"</td>
                    <td>Magic number - confirms this is an executable</td>
                </tr>
                <tr>
                    <td><code>e_lfanew</code></td>
                    <td>Offset 0x3C (fixed)</td>
                    <td>Varies per file</td>
                    <td>Pointer to PE Signature location</td>
                </tr>
            </table>

            <div class="info-box">
                <div class="info-box-title">ğŸ’¡ How e_lfanew Works</div>
                <p>
                    The field <code>e_lfanew</code> is <strong>always at offset 0x3C</strong> - this never changes.<br>
                    But the <strong>value inside</strong> tells you where to find the PE Signature:
                </p>
                <pre style="background: transparent; padding: 0; border: none; margin: 0.5rem 0;">
Step 1: Go to offset 0x3C
Step 2: Read the 4-byte value there (e.g., 80 00 00 00 = 0x80)
Step 3: Jump to that offset (0x80)
Step 4: You should find: 50 45 00 00 ("PE\0\0")
                </pre>
            </div>

            <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Offset 0x00: 4D 5A ...           ; e_magic = "MZ" (always)     â”‚
â”‚ ...                                                            â”‚
â”‚ Offset 0x3C: 80 00 00 00         ; e_lfanew = 0x80             â”‚
â”‚              â†“                     (this VALUE varies)         â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚ ...                                        â†“                   â”‚
â”‚ Offset 0x80: 50 45 00 00         ; PE Signature found here!    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </pre>

            <h2>ğŸ“‹ PE Signature & File Header</h2>

            <div class="definition">
                <div class="definition-title">ğŸ“– Definition: PE Signature</div>
                <p>
                    4 bytes that confirm this is a Windows PE file: <code>50 45 00 00</code><br>
                    In ASCII: "P" (0x50) + "E" (0x45) + null (0x00) + null (0x00) = <code>"PE\0\0"</code>
                </p>
            </div>

            <div class="info-box">
                <div class="info-box-title">ğŸ’¡ Why Both MZ and PE Signatures?</div>
                <table style="margin: 0.5rem 0; font-size: 0.9rem;">
                    <tr>
                        <th>Signature</th>
                        <th>Bytes</th>
                        <th>Purpose</th>
                    </tr>
                    <tr>
                        <td><code>MZ</code></td>
                        <td><code>4D 5A</code></td>
                        <td>Says "I might be an executable" (legacy DOS compatibility)</td>
                    </tr>
                    <tr>
                        <td><code>PE\0\0</code></td>
                        <td><code>50 45 00 00</code></td>
                        <td>Confirms "Yes, I'm definitely a Windows PE file!"</td>
                    </tr>
                </table>
                <p style="margin: 0.5rem 0 0 0;">
                    Historical reason: PE files start with MZ so old DOS systems show "This program cannot be run in DOS mode" instead of crashing. Windows uses e_lfanew to find the real PE data.
                </p>
            </div>

            <p>File Header (COFF Header) - 20 bytes:</p>

            <table>
                <tr>
                    <th>Field</th>
                    <th>Size</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>Machine</code></td>
                    <td>2</td>
                    <td>CPU type (0x14c=i386, 0x8664=AMD64)</td>
                </tr>
                <tr>
                    <td><code>NumberOfSections</code></td>
                    <td>2</td>
                    <td>How many sections are in the file</td>
                </tr>
                <tr>
                    <td><code>TimeDateStamp</code></td>
                    <td>4</td>
                    <td>Compilation time (Unix timestamp)</td>
                </tr>
                <tr>
                    <td><code>SizeOfOptionalHeader</code></td>
                    <td>2</td>
                    <td>Size of Optional Header</td>
                </tr>
                <tr>
                    <td><code>Characteristics</code></td>
                    <td>2</td>
                    <td>Flags (EXE, DLL, etc.)</td>
                </tr>
            </table>

            <h2>ğŸ“‹ Optional Header</h2>

            <p>Despite the name, it's <strong>required</strong> for EXE and DLL! Contains critical information:</p>

            <table>
                <tr>
                    <th>Field</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>Magic</code></td>
                    <td>0x10b = PE32, 0x20b = PE32+ (64-bit)</td>
                </tr>
                <tr>
                    <td><code>AddressOfEntryPoint</code></td>
                    <td><strong>RVA of entry point - where code execution starts!</strong></td>
                </tr>
                <tr>
                    <td><code>ImageBase</code></td>
                    <td>Preferred load address (usually 0x00400000)</td>
                </tr>
                <tr>
                    <td><code>SectionAlignment</code></td>
                    <td>Section alignment in memory</td>
                </tr>
                <tr>
                    <td><code>FileAlignment</code></td>
                    <td>Section alignment in file</td>
                </tr>
                <tr>
                    <td><code>SizeOfImage</code></td>
                    <td>Total size in memory</td>
                </tr>
                <tr>
                    <td><code>Subsystem</code></td>
                    <td>GUI (2), Console (3), Driver (1)</td>
                </tr>
                <tr>
                    <td><code>DataDirectory</code></td>
                    <td>Array of 16 entries - imports, exports, resources...</td>
                </tr>
            </table>

            <div class="definition">
                <div class="definition-title">ğŸ“– Definition: RVA (Relative Virtual Address)</div>
                <p>Address relative to ImageBase. Actual memory address = ImageBase + RVA.</p>
            </div>

            <div class="info-box">
                <div class="info-box-title">ğŸ’¡ Entry Point</div>
                <p>
                    <code>AddressOfEntryPoint</code> is the RVA of the first instruction to execute.<br>
                    <strong>This is the first place to look at in RE!</strong><br><br>
                    Actual address = ImageBase + EntryPoint<br>
                    For example: 0x00400000 + 0x1000 = 0x00401000
                </p>
            </div>

            <h2>ğŸ“¦ Sections</h2>

            <div class="definition">
                <div class="definition-title">ğŸ“– Definition: Section</div>
                <p>A region in the file with a specific purpose - code, data, resources, etc. Each section has a name, size, and permissions.</p>
            </div>

            <table>
                <tr>
                    <th>Section</th>
                    <th>Content</th>
                    <th>Typical Permissions</th>
                </tr>
                <tr>
                    <td><code>.text</code></td>
                    <td>Program code</td>
                    <td>Read + Execute</td>
                </tr>
                <tr>
                    <td><code>.data</code></td>
                    <td>Initialized global variables</td>
                    <td>Read + Write</td>
                </tr>
                <tr>
                    <td><code>.rdata</code></td>
                    <td>Read-only data, strings, imports</td>
                    <td>Read only</td>
                </tr>
                <tr>
                    <td><code>.bss</code></td>
                    <td>Uninitialized variables</td>
                    <td>Read + Write</td>
                </tr>
                <tr>
                    <td><code>.rsrc</code></td>
                    <td>Resources (icons, dialogs, strings)</td>
                    <td>Read only</td>
                </tr>
                <tr>
                    <td><code>.reloc</code></td>
                    <td>Relocation info (for loading at different address)</td>
                    <td>Read only</td>
                </tr>
            </table>

            <h3>Section Header Structure</h3>

            <p>Each Section Header is exactly 40 bytes and contains info about one Section:</p>

            <div class="info-box">
                <div class="info-box-title">ğŸ’¡ Section Header Entry (40 bytes)</div>
                <pre style="background: transparent; padding: 0; border: none; margin: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Field              â”‚ Size    â”‚ Example              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Name               â”‚ 8 bytes â”‚ ".text"              â”‚
â”‚ VirtualSize        â”‚ 4 bytes â”‚ 0x1000               â”‚
â”‚ VirtualAddress     â”‚ 4 bytes â”‚ 0x1000 (RVA)         â”‚
â”‚ SizeOfRawData      â”‚ 4 bytes â”‚ 0x800                â”‚
â”‚ PointerToRawData   â”‚ 4 bytes â”‚ 0x400 â† WHERE in fileâ”‚
â”‚ ... (other fields) â”‚ 12 bytesâ”‚                      â”‚
â”‚ Characteristics    â”‚ 4 bytes â”‚ 0x60000020 (R+X)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </pre>
            </div>

            <p><strong>The key field: <code>PointerToRawData</code></strong></p>
            <p>This tells you the file offset where the actual Section data starts!</p>

            <pre>
Example: 3 sections = 3 headers = 3 Ã— 40 = 120 bytes

Section Headers area in file:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .text header â”‚ PointerToRawData = 0x400 â”‚ â†’ Go to offset 0x400 for code
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .data header â”‚ PointerToRawData = 0x800 â”‚ â†’ Go to offset 0x800 for data
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .rsrc header â”‚ PointerToRawData = 0xC00 â”‚ â†’ Go to offset 0xC00 for resources
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </pre>

            <h2>ğŸ“¥ Import Table</h2>

            <div class="definition">
                <div class="definition-title">ğŸ“– Definition: Import Table</div>
                <p>A list of functions the program imports from other DLLs. Windows fills in the addresses at load time.</p>
            </div>

            <h3>Where is the Import Table?</h3>
            
            <p>This can be confusing! The Import Table involves <strong>two places</strong>:</p>

            <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  WHERE IS THE IMPORT TABLE?                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   OPTIONAL HEADER                              SECTIONS
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ...                 â”‚                    â”‚ .text               â”‚
  â”‚ DataDirectory[0]    â”‚                    â”‚ (code)              â”‚
  â”‚ DataDirectory[1] â”€â”€â”€â”¼â”€â”€â”€â”€â”€ POINTER â”€â”€â”€â”€â”€â–ºâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚   (Import Table)    â”‚      (RVA)         â”‚ .rdata or .idata    â”‚
  â”‚ DataDirectory[2]    â”‚                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚ ...                 â”‚                    â”‚ â”‚ IMPORT TABLE    â”‚ â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚ â”‚ (actual data)   â”‚ â”‚
                                             â”‚ â”‚ - kernel32.dll  â”‚ â”‚
   Contains: POINTER                         â”‚ â”‚   - CreateFile  â”‚ â”‚
   (tells you WHERE                          â”‚ â”‚   - ReadFile    â”‚ â”‚
   to find imports)                          â”‚ â”‚ - user32.dll    â”‚ â”‚
                                             â”‚ â”‚   - MessageBox  â”‚ â”‚
                                             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             
                                              Contains: ACTUAL DATA
                                              (the real import list)
            </pre>

            <div class="info-box">
                <div class="info-box-title">ğŸ’¡ Two Parts to Understand</div>
                <table style="margin: 0.5rem 0; font-size: 0.9rem;">
                    <tr>
                        <th>Location</th>
                        <th>What's there</th>
                        <th>Analogy</th>
                    </tr>
                    <tr>
                        <td><code>DataDirectory[1]</code></td>
                        <td>A <strong>pointer</strong> (RVA) saying "imports are at address X"</td>
                        <td>Street address on an envelope</td>
                    </tr>
                    <tr>
                        <td>Inside a Section<br>(usually <code>.rdata</code> or <code>.idata</code>)</td>
                        <td>The <strong>actual Import Table data</strong> (DLL names, function names)</td>
                        <td>The actual house at that address</td>
                    </tr>
                </table>
            </div>

            <p>Common imported functions (tells us what the program does):</p>

            <ul>
                <li><code>CreateFile</code>, <code>ReadFile</code> - file access</li>
                <li><code>RegOpenKey</code> - Registry access</li>
                <li><code>socket</code>, <code>connect</code> - network communication</li>
                <li><code>VirtualAlloc</code> - memory allocation</li>
                <li><code>CreateProcess</code> - running programs</li>
            </ul>

            <div class="info-box">
                <div class="info-box-title">ğŸ’¡ Important in RE</div>
                <p>
                    Scanning the Imports gives an important hint about what the program does!<br>
                    Malware sometimes tries to hide imports (dynamic loading, obfuscation).
                </p>
            </div>

            <h2>ğŸ“¤ Export Table</h2>

            <div class="definition">
                <div class="definition-title">ğŸ“– Definition: Export Table</div>
                <p>A list of functions the file exports for use by others. Common in DLLs.</p>
            </div>

            <p>Just like Import Table, the Export Table has a <strong>pointer</strong> and <strong>actual data</strong>:</p>

            <pre>
DataDirectory[0]  â†’  POINTER (RVA) saying "exports are at address X"
                           â†“
.edata section    â†’  ACTUAL EXPORT DATA (function names, addresses)
            </pre>

            <h2>ğŸ“‹ DataDirectory - The Master Pointer Table</h2>

            <p>
                The <code>DataDirectory</code> in the Optional Header is an array of 16 <strong>pointers</strong>.<br>
                Each entry points to different data stored in the sections:
            </p>

            <table>
                <tr>
                    <th>Index</th>
                    <th>Name</th>
                    <th>Points to</th>
                </tr>
                <tr>
                    <td>0</td>
                    <td><strong>Export Table</strong></td>
                    <td>Functions this file exports (for DLLs)</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td><strong>Import Table</strong></td>
                    <td>Functions imported from other DLLs</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>Resource Table</td>
                    <td>Icons, dialogs, strings, etc.</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>Exception Table</td>
                    <td>Exception handling info</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>Certificate Table</td>
                    <td>Digital signatures</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>Base Relocation</td>
                    <td>For loading at different address</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>Debug</td>
                    <td>Debug information</td>
                </tr>
                <tr>
                    <td>12</td>
                    <td>IAT</td>
                    <td>Import Address Table</td>
                </tr>
                <tr>
                    <td>14</td>
                    <td>CLR Runtime</td>
                    <td>.NET metadata</td>
                </tr>
            </table>

            <div class="info-box">
                <div class="info-box-title">ğŸ’¡ Key Concept: Headers Have Pointers, Sections Have Data</div>
                <pre style="background: transparent; padding: 0; border: none; margin: 0;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HEADERS vs SECTIONS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   OPTIONAL HEADER                      SECTIONS                 â”‚
â”‚   (DataDirectory)                      (actual content)         â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ [0] Export â”€â”€â”¼â”€â”€â”€â”€â–º POINTER â”€â”€â”€â”€â–ºâ”‚ .edata: Export data  â”‚   â”‚
â”‚   â”‚ [1] Import â”€â”€â”¼â”€â”€â”€â”€â–º POINTER â”€â”€â”€â”€â–ºâ”‚ .rdata: Import data  â”‚   â”‚
â”‚   â”‚ [2] Resourceâ”€â”¼â”€â”€â”€â”€â–º POINTER â”€â”€â”€â”€â–ºâ”‚ .rsrc:  Icons, etc.  â”‚   â”‚
â”‚   â”‚ [5] Reloc  â”€â”€â”¼â”€â”€â”€â”€â–º POINTER â”€â”€â”€â”€â–ºâ”‚ .reloc: Reloc data   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   Contains: RVA + Size               Contains: ACTUAL DATA      â”‚
â”‚   (WHERE to find it)                 (the real content)         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </pre>
                <p style="margin: 0.5rem 0 0 0;">
                    <strong>Remember:</strong> Headers never contain the actual data - they only contain pointers that tell you where to find the data in the sections!
                </p>
            </div>

            <h2>ğŸ”§ Tools for PE Analysis</h2>

            <ul>
                <li><strong>PE-bear</strong> - excellent graphical PE analysis tool</li>
                <li><strong>CFF Explorer</strong> - advanced PE editor</li>
                <li><strong>pestudio</strong> - PE analysis for malware identification</li>
                <li><strong>Detect It Easy (DIE)</strong> - identify packers and compilers</li>
                <li><strong>pefile (Python)</strong> - library for PE analysis in code</li>
            </ul>

            <h2>ğŸ“‹ Chapter Summary</h2>
            
            <ul>
                <li><strong>PE</strong> - Windows executable file format</li>
                <li><strong>DOS Header</strong> - starts with MZ, points to PE Header</li>
                <li><strong>File Header</strong> - CPU type, number of sections</li>
                <li><strong>Optional Header</strong> - Entry Point, ImageBase, imports</li>
                <li><strong>Sections</strong> - .text (code), .data (data), .rsrc (resources)</li>
                <li><strong>Import Table</strong> - imported functions (very important for analysis!)</li>
                <li><strong>RVA</strong> - relative address, need to add ImageBase</li>
            </ul>

            <div class="nav-buttons">
                <a href="chapter6.html" class="nav-btn">â† Chapter 6: Assembly Flow Control</a>
                <a href="chapter8.html" class="nav-btn">Chapter 8: Calling Conventions â†’</a>
            </div>
        </div>
    </div>
</body>
</html>
