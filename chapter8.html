<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 8: Calling Conventions</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #131a2b;
            --bg-card: #1a2235;
            --accent-primary: #00ff88;
            --accent-secondary: #00b4d8;
            --accent-warning: #ff6b35;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --border-color: #2a3548;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.9; }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        nav { background: var(--bg-secondary); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
        nav a { color: var(--accent-primary); text-decoration: none; }
        .chapter-header { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%); padding: 4rem 2rem; text-align: center; border-bottom: 1px solid var(--border-color); }
        .chapter-number { display: inline-block; background: linear-gradient(135deg, #00ff88 0%, #00b4d8 100%); color: var(--bg-primary); padding: 0.5rem 1.5rem; border-radius: 30px; font-weight: 700; margin-bottom: 1rem; }
        h1 { font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #00ff88 0%, #00b4d8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: var(--text-secondary); font-size: 1.1rem; }
        .content { padding: 3rem 0; }
        h2 { font-size: 1.8rem; color: var(--accent-primary); margin: 3rem 0 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color); }
        h3 { font-size: 1.3rem; color: var(--accent-secondary); margin: 2rem 0 1rem; }
        p { margin-bottom: 1.5rem; }
        .definition { background: var(--bg-card); border-left: 4px solid var(--accent-primary); padding: 1.5rem; border-radius: 0 10px 10px 0; margin: 1.5rem 0; }
        .definition-title { color: var(--accent-primary); font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .info-box { background: rgba(0, 180, 216, 0.1); border: 1px solid var(--accent-secondary); border-radius: 10px; padding: 1.5rem; margin: 1.5rem 0; }
        .info-box-title { color: var(--accent-secondary); font-weight: 700; margin-bottom: 0.5rem; }
        ul, ol { margin: 1rem 0 1.5rem 1.5rem; }
        li { margin-bottom: 0.8rem; }
        code { font-family: 'Fira Code', monospace; background: var(--bg-card); padding: 0.2rem 0.5rem; border-radius: 4px; color: var(--accent-primary); font-size: 0.9rem; }
        pre { font-family: 'Fira Code', monospace; background: var(--bg-card); padding: 1.5rem; border-radius: 10px; overflow-x: auto; margin: 1.5rem 0; border: 1px solid var(--border-color); line-height: 1.6; }
        .diagram { background: var(--bg-card); border-radius: 15px; padding: 2rem; margin: 2rem 0; text-align: center; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; background: var(--bg-card); border-radius: 10px; overflow: hidden; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-secondary); color: var(--accent-primary); font-weight: 600; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--border-color); }
        .nav-btn { background: var(--bg-card); color: var(--text-primary); padding: 1rem 2rem; border-radius: 10px; text-decoration: none; border: 1px solid var(--border-color); transition: all 0.3s; }
        .nav-btn:hover { border-color: var(--accent-primary); transform: translateY(-3px); }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">‚Üê Back to Main Menu</a>
    </nav>

    <header class="chapter-header">
        <div class="chapter-number">Chapter 8</div>
        <h1>Calling Conventions</h1>
        <p class="subtitle">How functions receive parameters and return values</p>
    </header>

    <div class="container">
        <div class="content">
            
            <h2>üìû What is a Calling Convention?</h2>

            <div class="definition">
                <div class="definition-title">üìñ Definition: Calling Convention</div>
                <p>An agreement that defines:<br>
                1. <strong>Where</strong> parameters are passed (Stack? Registers?)<br>
                2. <strong>In what order</strong> parameters are pushed<br>
                3. <strong>Who cleans</strong> the Stack after the call (caller or callee)<br>
                4. <strong>Which registers</strong> are preserved</p>
            </div>

            <p>
                In RE, you must know the Calling Convention to understand what values are passed to a function and what it returns.
            </p>

            <h2>üìö cdecl - C Declaration</h2>

            <div class="definition">
                <div class="definition-title">üìñ Definition: cdecl</div>
                <p>The standard Calling Convention for C.<br>
                Parameters: Stack (right to left)<br>
                Cleanup: <strong>Caller</strong> cleans the Stack<br>
                Return value: EAX</p>
            </div>

            <pre>
// C code
int result = add(1, 2, 3);

// Assembly (cdecl)
push 3              ; Parameter 3 (rightmost first)
push 2              ; Parameter 2
push 1              ; Parameter 1
call add            ; Call function
add esp, 12         ; Caller cleans (3 params √ó 4 bytes)
; EAX = result
            </pre>

            <div class="diagram">
                <svg viewBox="0 0 350 200" xmlns="http://www.w3.org/2000/svg">
                    <text x="175" y="20" text-anchor="middle" fill="#00ff88" font-size="14" font-weight="bold">Stack after CALL (cdecl)</text>
                    
                    <rect x="100" y="35" width="150" height="30" fill="#1a2235" stroke="#a855f7" stroke-width="2"/>
                    <text x="175" y="55" text-anchor="middle" fill="#a855f7" font-size="11">Parameter 3 (=3)</text>
                    <text x="265" y="55" fill="#a0a0a0" font-size="9" font-family="Fira Code">[EBP+16]</text>
                    
                    <rect x="100" y="65" width="150" height="30" fill="#1a2235" stroke="#a855f7" stroke-width="2"/>
                    <text x="175" y="85" text-anchor="middle" fill="#a855f7" font-size="11">Parameter 2 (=2)</text>
                    <text x="265" y="85" fill="#a0a0a0" font-size="9" font-family="Fira Code">[EBP+12]</text>
                    
                    <rect x="100" y="95" width="150" height="30" fill="#1a2235" stroke="#a855f7" stroke-width="2"/>
                    <text x="175" y="115" text-anchor="middle" fill="#a855f7" font-size="11">Parameter 1 (=1)</text>
                    <text x="265" y="115" fill="#a0a0a0" font-size="9" font-family="Fira Code">[EBP+8]</text>
                    
                    <rect x="100" y="125" width="150" height="30" fill="#1a2235" stroke="#ff6b35" stroke-width="2"/>
                    <text x="175" y="145" text-anchor="middle" fill="#ff6b35" font-size="11">Return Address</text>
                    <text x="265" y="145" fill="#a0a0a0" font-size="9" font-family="Fira Code">[EBP+4]</text>
                    
                    <rect x="100" y="155" width="150" height="30" fill="#1a2235" stroke="#00b4d8" stroke-width="2"/>
                    <text x="175" y="175" text-anchor="middle" fill="#00b4d8" font-size="11">Saved EBP</text>
                    <text x="265" y="175" fill="#00ff88" font-size="9" font-family="Fira Code">‚Üê EBP</text>
                </svg>
            </div>

            <h2>üìö stdcall - Standard Call</h2>

            <div class="definition">
                <div class="definition-title">üìñ Definition: stdcall</div>
                <p>The Calling Convention for Windows API.<br>
                Parameters: Stack (right to left)<br>
                Cleanup: <strong>Callee</strong> cleans the Stack<br>
                Return value: EAX</p>
            </div>

            <pre>
// Windows API call
HANDLE h = CreateFileA("test.txt", ...);

// Assembly (stdcall)
push ...            ; Parameters
push "test.txt"
call CreateFileA    ; Function cleans the Stack
; No ADD ESP after! The function does RET 28
            </pre>

            <div class="info-box">
                <div class="info-box-title">üí° How to identify stdcall?</div>
                <p>
                    The function ends with <code>RET n</code> (e.g., <code>RET 0x1C</code>)<br>
                    instead of a regular <code>RET</code>. The n specifies how many bytes to clean.
                </p>
            </div>

            <h2>üìö fastcall</h2>

            <div class="definition">
                <div class="definition-title">üìñ Definition: fastcall</div>
                <p>Passes the first 2 parameters <strong>in registers</strong> (ECX, EDX).<br>
                Remaining parameters: Stack<br>
                Cleanup: Callee<br>
                Faster because less memory access!</p>
            </div>

            <pre>
// fastcall function
int __fastcall func(int a, int b, int c);

// Assembly
mov edx, 2          ; Parameter 2 in EDX
mov ecx, 1          ; Parameter 1 in ECX
push 3              ; Parameter 3 on Stack
call func
            </pre>

            <h2>üìö x64 Calling Convention (Windows)</h2>

            <p>
                In 64-bit there's a unified calling convention:
            </p>

            <ul>
                <li>First 4 parameters: <code>RCX</code>, <code>RDX</code>, <code>R8</code>, <code>R9</code></li>
                <li>Remaining parameters: Stack</li>
                <li><strong>Shadow Space:</strong> Caller must allocate 32 bytes on Stack even if fewer than 4 parameters</li>
                <li>Return value: <code>RAX</code></li>
            </ul>

            <pre>
// x64 Windows
func(1, 2, 3, 4, 5);

// Assembly
sub rsp, 40         ; Shadow space (32) + param 5 (8)
mov [rsp+32], 5     ; Parameter 5 on Stack
mov r9d, 4          ; Parameter 4
mov r8d, 3          ; Parameter 3
mov edx, 2          ; Parameter 2
mov ecx, 1          ; Parameter 1
call func
add rsp, 40
            </pre>

            <h2>üìä Conventions Comparison</h2>

            <table>
                <tr>
                    <th>Feature</th>
                    <th>cdecl</th>
                    <th>stdcall</th>
                    <th>fastcall</th>
                    <th>x64 (Win)</th>
                </tr>
                <tr>
                    <td>Parameters</td>
                    <td>Stack</td>
                    <td>Stack</td>
                    <td>ECX,EDX + Stack</td>
                    <td>RCX,RDX,R8,R9 + Stack</td>
                </tr>
                <tr>
                    <td>Order</td>
                    <td>RTL</td>
                    <td>RTL</td>
                    <td>RTL</td>
                    <td>LTR for registers</td>
                </tr>
                <tr>
                    <td>Stack Cleanup</td>
                    <td>Caller</td>
                    <td>Callee</td>
                    <td>Callee</td>
                    <td>Caller</td>
                </tr>
                <tr>
                    <td>Return Value</td>
                    <td>EAX</td>
                    <td>EAX</td>
                    <td>EAX</td>
                    <td>RAX</td>
                </tr>
            </table>

            <p><small>RTL = Right To Left, LTR = Left To Right</small></p>

            <h2>üîç Identification in RE</h2>

            <div class="info-box">
                <div class="info-box-title">üí° How to identify Calling Convention</div>
                <p><strong>cdecl:</strong></p>
                <pre style="background: transparent; border: none; padding: 0; margin: 0.5rem 0;">
call func
add esp, XX      ; Caller cleans
                </pre>
                
                <p style="margin-top: 1rem;"><strong>stdcall:</strong></p>
                <pre style="background: transparent; border: none; padding: 0; margin: 0.5rem 0;">
call func
; No ADD ESP! The function does:
ret XX           ; Callee cleans
                </pre>
                
                <p style="margin-top: 1rem;"><strong>fastcall:</strong></p>
                <pre style="background: transparent; border: none; padding: 0; margin: 0.5rem 0;">
mov ecx, param1
mov edx, param2
call func
                </pre>
            </div>

            <h2>üìù Full Example</h2>

            <pre>
; Function that adds 2 numbers (cdecl)
; int add(int a, int b)

add:
    push ebp              ; prologue
    mov ebp, esp
    
    mov eax, [ebp+8]      ; EAX = a (first parameter)
    add eax, [ebp+12]     ; EAX = a + b (second parameter)
    
    pop ebp               ; epilogue
    ret                   ; return, EAX = result

; Calling the function
    push 20               ; b = 20
    push 10               ; a = 10
    call add
    add esp, 8            ; clean 2 parameters (cdecl)
    ; EAX = 30
            </pre>

            <h2>üìã Chapter Summary</h2>
            
            <ul>
                <li><strong>Calling Convention</strong> - rules for passing parameters and Stack cleanup</li>
                <li><strong>cdecl</strong> - standard C, Caller cleans</li>
                <li><strong>stdcall</strong> - Windows API, Callee cleans</li>
                <li><strong>fastcall</strong> - parameters in registers (ECX, EDX)</li>
                <li><strong>x64</strong> - RCX, RDX, R8, R9 + Shadow Space</li>
                <li>Return value always in <strong>EAX/RAX</strong></li>
            </ul>

            <div class="nav-buttons">
                <a href="chapter7.html" class="nav-btn">‚Üê Chapter 7: PE Format</a>
                <a href="chapter9.html" class="nav-btn">Chapter 9: Analysis Tools ‚Üí</a>
            </div>
        </div>
    </div>
</body>
</html>
